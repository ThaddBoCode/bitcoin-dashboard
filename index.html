<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="apple-touch-icon" href="icon-180.png">
  <meta name="apple-mobile-web-app-title" content="Bitcoin">
  <title>Bitcoin</title>

  <!-- Premium Typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500;600&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg0: #05080f;
      --bg1: #0a0f1a;
      --bg2: #0f1520;

      --card: rgba(255,255,255,0.03);
      --card-border: rgba(255,255,255,0.06);
      --card-hover: rgba(255,255,255,0.05);

      --text: rgba(255,255,255,0.95);
      --text-secondary: rgba(255,255,255,0.6);
      --text-muted: rgba(255,255,255,0.4);

      --ok: #34d399;
      --warn: #fbbf24;
      --bad: #f87171;

      --btc: #f7931a;
      --btc-glow: rgba(247,147,26,0.15);
      --btc-soft: rgba(247,147,26,0.8);
      --eur: #3b82f6;
      --eur-glow: rgba(59,130,246,0.15);
      --price: #a78bfa;
      --price-glow: rgba(167,139,250,0.15);

      --glass: rgba(255,255,255,0.02);
      --glass-border: rgba(255,255,255,0.08);

      --radius-sm: 10px;
      --radius-md: 16px;
      --radius-lg: 24px;
      --radius-xl: 32px;

      --font-display: 'Instrument Serif', Georgia, serif;
      --font-body: 'DM Sans', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', ui-monospace, monospace;

      --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-body);
      color: var(--text);
      background: var(--bg0);
      min-height: 100vh;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* Ambient background */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 100% 60% at 0% 0%, rgba(247,147,26,0.08), transparent 50%),
        radial-gradient(ellipse 80% 50% at 100% 0%, rgba(59,130,246,0.06), transparent 50%),
        radial-gradient(ellipse 90% 50% at 50% 100%, rgba(167,139,250,0.05), transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    /* Noise texture overlay */
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      opacity: 0.03;
      pointer-events: none;
      z-index: -1;
    }

    .wrap {
      max-width: 540px;
      margin: 0 auto;
      padding: max(20px, env(safe-area-inset-top)) 16px 40px;
    }

    /* Header */
    .topbar {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-icon {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, var(--btc) 0%, #e67e00 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 32px var(--btc-glow), inset 0 1px 0 rgba(255,255,255,0.2);
    }

    .brand-icon svg {
      width: 24px;
      height: 24px;
      fill: white;
    }

    h1 {
      font-family: var(--font-display);
      font-size: 28px;
      font-weight: 400;
      letter-spacing: -0.02em;
      line-height: 1.1;
    }

    .sub {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-end;
    }

    .btnRow {
      display: flex;
      gap: 8px;
    }

    button, a.btn {
      appearance: none;
      border: 1px solid var(--glass-border);
      background: var(--glass);
      backdrop-filter: blur(12px);
      color: var(--text);
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-family: var(--font-body);
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      white-space: nowrap;
      transition: all 0.2s var(--ease-out);
    }

    button:hover, a.btn:hover {
      background: var(--card-hover);
      border-color: rgba(255,255,255,0.12);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    .btnIcon {
      width: 40px;
      padding: 10px;
      text-align: center;
      font-size: 16px;
    }

    .pillRow {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      border-radius: 100px;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.02em;
      white-space: nowrap;
      transition: all 0.2s var(--ease-out);
    }

    .pill::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      opacity: 0.6;
    }

    #statusPill.ok { color: var(--ok); border-color: rgba(52,211,153,0.2); }
    #statusPill.ok::before { background: var(--ok); opacity: 1; box-shadow: 0 0 8px var(--ok); }
    #statusPill.warn { color: var(--warn); border-color: rgba(251,191,36,0.2); }
    #statusPill.warn::before { background: var(--warn); opacity: 1; }
    #statusPill.bad { color: var(--bad); border-color: rgba(248,113,113,0.2); }
    #statusPill.bad::before { background: var(--bad); opacity: 1; }

    /* Wallet Identity Card */
    .walletCard {
      position: relative;
      padding: 24px;
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, rgba(247,147,26,0.08) 0%, rgba(247,147,26,0.02) 100%);
      border: 1px solid rgba(247,147,26,0.15);
      overflow: hidden;
      margin-bottom: 20px;
    }

    .walletCard::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, var(--btc) 0%, rgba(247,147,26,0.3) 100%);
      border-radius: 4px 0 0 4px;
    }

    .walletCard::after {
      content: "₿";
      position: absolute;
      right: -20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 140px;
      font-weight: 700;
      color: rgba(247,147,26,0.04);
      pointer-events: none;
    }

    .walletName {
      font-family: var(--font-display);
      font-size: 32px;
      font-weight: 400;
      letter-spacing: -0.02em;
      color: var(--text);
      margin-bottom: 8px;
    }

    .walletAddr {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
      word-break: break-all;
      line-height: 1.6;
    }

    /* Card Stack */
    .stack {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      position: relative;
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-lg);
      padding: 20px;
      backdrop-filter: blur(20px);
      transition: all 0.3s var(--ease-out);
    }

    .card:hover {
      background: var(--card-hover);
      border-color: rgba(255,255,255,0.1);
    }

    /* Hero Stats Card */
    .heroCard {
      background: linear-gradient(180deg, rgba(255,255,255,0.04) 0%, rgba(255,255,255,0.01) 100%);
    }

    .heroHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .heroTitle {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: var(--text-secondary);
    }

    .heroDot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--btc);
      box-shadow: 0 0 12px var(--btc), 0 0 4px var(--btc);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }

    .heroGrid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .heroRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 18px;
      background: rgba(0,0,0,0.25);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      transition: all 0.2s var(--ease-out);
    }

    .heroRow:hover {
      background: rgba(0,0,0,0.35);
      border-color: rgba(255,255,255,0.1);
    }

    .heroRow.btc-row { border-left: 3px solid var(--btc); }
    .heroRow.sats-row { border-left: 3px solid var(--text-secondary); }
    .heroRow.eur-row { border-left: 3px solid var(--eur); }

    .heroKey {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-secondary);
    }

    .heroVal {
      font-family: var(--font-mono);
      font-size: 20px;
      font-weight: 600;
      letter-spacing: -0.02em;
      text-align: right;
    }

    .btcVal { color: var(--btc-soft); }
    .eurVal { color: #60a5fa; }
    .satsVal { color: var(--text); }

    .miniBadges {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--glass-border);
    }

    .miniBadges .pill::before { display: none; }
    .pill.btc { color: var(--btc-soft); border-color: rgba(247,147,26,0.2); }
    .pill.eur { color: #60a5fa; border-color: rgba(59,130,246,0.2); }
    .pill.purple { color: var(--price); border-color: rgba(167,139,250,0.2); }

    .tiny {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 12px;
      line-height: 1.5;
    }

    /* Chart Cards */
    .chartCard {
      padding: 20px;
    }

    .title {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .title strong {
      font-family: var(--font-display);
      font-size: 18px;
      font-weight: 400;
      letter-spacing: -0.01em;
    }

    .title .tiny {
      margin-top: 4px;
    }

    .chartBox {
      height: 200px;
      margin: 0 -8px;
    }

    .chartBoxSmall {
      height: 160px;
      margin: 0 -8px;
    }

    /* Transaction List */
    .txList {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 16px;
    }

    .txItem {
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      padding: 14px 16px;
      transition: all 0.2s var(--ease-out);
    }

    .txItem:hover {
      background: rgba(0,0,0,0.3);
      border-color: rgba(255,255,255,0.1);
      transform: translateX(4px);
    }

    .txTop {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .txTime {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .txId {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
      padding: 3px 8px;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
    }

    .txBottom {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .txDelta {
      font-family: var(--font-mono);
      font-size: 15px;
      font-weight: 600;
    }

    .pos { color: var(--ok); }
    .neg { color: var(--bad); }

    .txStatus .pill::before { display: none; }

    /* Error Box */
    .error {
      display: none;
      margin-top: 16px;
      padding: 12px 16px;
      background: rgba(248,113,113,0.1);
      border: 1px solid rgba(248,113,113,0.2);
      border-radius: var(--radius-sm);
      color: var(--bad);
      font-size: 13px;
    }

    /* Responsive */
    @media (max-width: 400px) {
      h1 { font-size: 24px; }
      .walletName { font-size: 26px; }
      .heroVal { font-size: 18px; }
      .heroRow { padding: 14px; }
    }

    /* Loading shimmer */
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .loading {
      background: linear-gradient(90deg, 
        rgba(255,255,255,0.03) 25%, 
        rgba(255,255,255,0.08) 50%, 
        rgba(255,255,255,0.03) 75%
      );
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div class="brand">
        <div class="brand-icon">
          <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/></svg>
        </div>
        <div>
          <h1 id="walletTitle">Bitcoin</h1>
          <p class="sub" id="walletSub">Wallet</p>
        </div>
      </div>

      <div class="actions">
        <div class="btnRow">
          <a class="btn btnIcon" id="explorerBtn" target="_blank" rel="noopener" title="Explorer">↗</a>
          <button class="btn btnIcon" id="refreshBtn" title="Aktualisieren">↻</button>
        </div>

      </div>
    </div>

    <div class="walletCard" id="walletCard">
      <div class="walletName" id="walletName">—</div>
      <div class="walletAddr" id="walletAddr">—</div>
    </div>

    <div class="stack">
      <div class="card heroCard">
        <div class="heroHeader">
          <div class="heroTitle"><span class="heroDot"></span>Aktueller Stand</div>
          <span class="pill btc" id="todayPill">–</span>
        </div>

        <div class="heroGrid">
          <div class="heroRow btc-row">
            <div class="heroKey">BTC</div>
            <div class="heroVal btcVal" id="heroBtc">–</div>
          </div>
          <div class="heroRow sats-row">
            <div class="heroKey">Sats</div>
            <div class="heroVal satsVal" id="heroSats">–</div>
          </div>
          <div class="heroRow eur-row">
            <div class="heroKey">EUR</div>
            <div class="heroVal eurVal" id="heroEur">–</div>
          </div>
        </div>

        <div class="miniBadges">
          <span class="pill btc" id="pendingPill">Offen: –</span>
          <span class="pill" id="txCountPill">Bewegungen: –</span>
        </div>


        <div class="error" id="errBox"></div>
      </div>

      <div class="card chartCard">
        <div class="title">
          <div>
            <strong style="color:var(--btc-soft);">Bestand</strong>
            <div class="tiny">BTC-Balance über Zeit</div>
          </div>
          <span class="pill btc" id="chartMeta">–</span>
        </div>
        <div class="chartBox"><canvas id="balanceChart"></canvas></div>
      </div>

      <div class="card chartCard">
        <div class="title">
          <div>
            <strong style="color:#60a5fa;">Wert</strong>
            <div class="tiny">EUR-Gegenwert pro Tag</div>
          </div>
          <span class="pill eur" id="eurMeta">–</span>
        </div>
        <div class="chartBoxSmall"><canvas id="eurChart"></canvas></div>
      </div>

      <div class="card chartCard">
        <div class="title">
          <div>
            <strong style="color:var(--price);">BTC-Preis</strong>
            <div class="tiny">Tageswerte in EUR</div>
          </div>
          <span class="pill purple" id="priceMeta">–</span>
        </div>
        <div class="chartBoxSmall"><canvas id="priceChart"></canvas></div>
      </div>

      <div class="card">
        <div class="title">
          <div>
            <strong>Transaktionen</strong>
            <div class="tiny">Letzte Bewegungen</div>
          </div>
          <span class="pill" id="txMeta">–</span>
        </div>

        <div class="txList" id="txList"></div>
      </div>
    </div>
  </div>

  <script>
    const ADDRESS_BOOK = Object.freeze({
      "bc1qpl73fwdsankdjz0tcetmndfdjgadr54tqxtya0": "Juna",
    });

    function getParam(name){
      const url = new URL(window.location.href);
      return url.searchParams.get(name) || "";
    }

    function normalizeAddr(a){
      return (a || "")
        .trim()
        .toLowerCase()
        .replace(/^bitcoin:/, "");
    }

    const ADDRESS = normalizeAddr(getParam("addr"));
    const WALLET_NAME = ADDRESS_BOOK[ADDRESS];

    if(!WALLET_NAME){
      document.body.innerHTML = `
        <div style="max-width:520px;margin:80px auto;padding:24px;color:white;
                    font-family:'DM Sans',system-ui,sans-serif;text-align:center;">
          <div style="font-size:48px;margin-bottom:16px;opacity:0.3;">₿</div>
          <h2 style="margin:0 0 12px 0;font-weight:500;">Adresse nicht erlaubt</h2>
          <p style="opacity:.6;margin:0;font-size:14px;">
            Bitte einen gültigen Link mit <code style="background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:4px;">?addr=...</code> verwenden.
          </p>
        </div>`;
      throw new Error("Address not in allowlist");
    }

    const MEMPOOL = "https://mempool.space/api";
    const COINGECKO = "https://api.coingecko.com/api/v3";

    const COLORS = {
      btc:   "#f7931a",
      btc2:  "#fbbf24",
      eur:   "#3b82f6",
      eur2:  "#60a5fa",
      price: "#a78bfa",
      grid:  "rgba(255,255,255,0.04)",
      ticks: "rgba(255,255,255,0.5)"
    };

    const el = (id) => document.getElementById(id);

    function satsToBtcNum(sats){ return sats / 100_000_000; }
    function fmtBtcCompact(btc){
      const abs = Math.abs(btc);
      const digits = abs >= 1 ? 6 : 8;
      return btc.toFixed(digits).replace(/0+$/,'').replace(/\.$/,'');
    }
    function fmtSats(sats){ return new Intl.NumberFormat("de-DE").format(sats); }

    function fmtEurNumberOnly(eur){
      return new Intl.NumberFormat("de-DE", { maximumFractionDigits: 0 }).format(eur);
    }

    function fmtDate(ts){
      if(!ts) return "—";
      const d = new Date(ts * 1000);
      return d.toLocaleString("de-DE", { dateStyle:"medium", timeStyle:"short" });
    }
    function dayKeyFromUnix(ts){
      const d = new Date(ts * 1000);
      const y = d.getUTCFullYear();
      const m = String(d.getUTCMonth()+1).padStart(2,"0");
      const da = String(d.getUTCDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }
    function dayKeyFromMs(ms){
      const d = new Date(ms);
      const y = d.getUTCFullYear();
      const m = String(d.getUTCMonth()+1).padStart(2,"0");
      const da = String(d.getUTCDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    }
    function startOfDayUnix(ts){
      const d = new Date(ts*1000);
      d.setUTCHours(0,0,0,0);
      return Math.floor(d.getTime()/1000);
    }
    function addDaysUnix(ts, days){ return ts + (days * 86400); }

    async function fetchJson(url){
      const r = await fetch(url, { cache:"no-store" });
      if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.json();
    }

    function setStatusLoading(){
      // Status elements removed
    }
    function setStatusOk(){
      // Status elements removed
    }
    function setStatusError(){
      // Status elements removed
    }
    function showError(msg){
      const box = el("errBox");
      box.style.display = "block";
      box.textContent = msg;
      setStatusError();
    }
    function clearError(){
      const box = el("errBox");
      box.style.display = "none";
      box.textContent = "";
    }

    function computeDeltaSats(tx){
      let inSats = 0, outSats = 0;
      if(Array.isArray(tx.vin)){
        for(const vin of tx.vin){
          const prev = vin.prevout;
          if(prev && prev.scriptpubkey_address === ADDRESS){
            inSats += (prev.value || 0);
          }
        }
      }
      if(Array.isArray(tx.vout)){
        for(const vout of tx.vout){
          if(vout.scriptpubkey_address === ADDRESS){
            outSats += (vout.value || 0);
          }
        }
      }
      return outSats - inSats;
    }

    let balanceChart, eurChart, priceChart;
    function destroyCharts(){
      if(balanceChart) balanceChart.destroy();
      if(eurChart) eurChart.destroy();
      if(priceChart) priceChart.destroy();
      balanceChart = eurChart = priceChart = null;
    }

    function makeStepLine(ctx, labels, data, label, changeIdxSet, colorHex){
      const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
      gradient.addColorStop(0, colorHex + "40");
      gradient.addColorStop(1, colorHex + "00");

      return new Chart(ctx, {
        type:"line",
        data:{
          labels,
          datasets:[{
            label,
            data,
            stepped:true,
            tension:0,
            borderWidth:2,
            borderColor: colorHex,
            backgroundColor: gradient,
            fill: true,
            pointRadius: (c) => changeIdxSet?.has(c.dataIndex) ? 4 : 0,
            pointHoverRadius: 6,
            pointHitRadius: 14,
            pointBackgroundColor: colorHex,
            pointBorderColor: "rgba(255,255,255,0.9)",
            pointBorderWidth: 2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{ display:false },
            tooltip:{
              mode:"index",
              intersect:false,
              backgroundColor: "rgba(0,0,0,0.8)",
              titleFont: { family: "'DM Sans', sans-serif", size: 12 },
              bodyFont: { family: "'JetBrains Mono', monospace", size: 13 },
              padding: 12,
              cornerRadius: 8,
              borderColor: "rgba(255,255,255,0.1)",
              borderWidth: 1
            }
          },
          interaction:{ mode:"index", intersect:false },
          scales:{
            x:{
              ticks:{
                maxTicksLimit: 5,
                color: COLORS.ticks,
                font: { family: "'DM Sans', sans-serif", size: 11 }
              },
              grid:{ color: COLORS.grid, drawBorder: false }
            },
            y:{
              ticks:{
                color: COLORS.ticks,
                font: { family: "'JetBrains Mono', monospace", size: 11 }
              },
              grid:{ color: COLORS.grid, drawBorder: false }
            }
          }
        }
      });
    }

    function renderTxList(txs){
      const list = el("txList");
      list.innerHTML = "";

      for(const tx of txs.slice(0, 10)){
        const delta = computeDeltaSats(tx);
        const deltaBtc = satsToBtcNum(delta);
        const isConfirmed = !!tx.status?.confirmed;
        const time = isConfirmed ? tx.status.block_time : (tx.status?.block_time || null);

        const item = document.createElement("div");
        item.className = "txItem";

        const top = document.createElement("div");
        top.className = "txTop";

        const timeEl = document.createElement("div");
        timeEl.className = "txTime";
        timeEl.textContent = fmtDate(time);

        const idEl = document.createElement("div");
        idEl.className = "txId";
        idEl.textContent = tx.txid.slice(0, 8) + "…" + tx.txid.slice(-6);

        top.appendChild(timeEl);
        top.appendChild(idEl);

        const bottom = document.createElement("div");
        bottom.className = "txBottom";

        const deltaEl = document.createElement("div");
        deltaEl.className = "txDelta " + (deltaBtc >= 0 ? "pos" : "neg");
        const sign = deltaBtc >= 0 ? "+" : "−";
        deltaEl.textContent = `${sign}${fmtBtcCompact(Math.abs(deltaBtc))} BTC`;

        const statusEl = document.createElement("div");
        statusEl.className = "txStatus";
        statusEl.innerHTML = isConfirmed
          ? `<span class="pill" style="color:var(--ok);border-color:rgba(52,211,153,0.2);">Bestätigt</span>`
          : `<span class="pill" style="color:var(--warn);border-color:rgba(251,191,36,0.2);">Offen</span>`;

        bottom.appendChild(deltaEl);
        bottom.appendChild(statusEl);

        item.appendChild(top);
        item.appendChild(bottom);

        list.appendChild(item);
      }
    }

    async function fetchAllConfirmedTxs(){
      const all = [];
      let lastSeen = null;
      let page = 0;

      while(true){
        page++;
        const url = lastSeen
          ? `${MEMPOOL}/address/${ADDRESS}/txs/chain/${lastSeen}`
          : `${MEMPOOL}/address/${ADDRESS}/txs/chain`;

        const chunk = await fetchJson(url);
        if(!Array.isArray(chunk) || chunk.length === 0) break;

        all.push(...chunk);
        lastSeen = chunk[chunk.length - 1].txid;

        if(page > 500) break;
      }
      return all;
    }

    function buildDailyStepSeriesFromTxs(confirmedTxsAsc){
      const deltasByDay = new Map();
      let firstTs = null;

      for(const tx of confirmedTxsAsc){
        const ts = tx.status?.block_time;
        if(!ts) continue;
        if(firstTs == null || ts < firstTs) firstTs = ts;

        const day = startOfDayUnix(ts);
        const delta = computeDeltaSats(tx);
        deltasByDay.set(day, (deltasByDay.get(day) || 0) + delta);
      }

      const todayDay = startOfDayUnix(Math.floor(Date.now()/1000));
      const startDay = firstTs ? startOfDayUnix(firstTs) : todayDay;

      const labels = [];
      const balancesBtc = [];
      let runningSats = 0;

      for(let d = startDay; d <= todayDay; d = addDaysUnix(d, 1)){
        runningSats += (deltasByDay.get(d) || 0);
        const dateObj = new Date(d*1000);
        labels.push(dateObj.toLocaleDateString("de-DE", { day:"2-digit", month:"short", timeZone: "UTC" }));
        balancesBtc.push(satsToBtcNum(runningSats));
      }

      const changeIdxSet = new Set();
      for(let i=0;i<labels.length;i++){
        const dayUnix = startDay + i*86400;
        if(deltasByDay.get(dayUnix)) changeIdxSet.add(i);
      }

      return { startDay, todayDay, labels, balancesBtc, changeIdxSet };
    }

    async function fetchBtcEurPriceMap(fromUnix, toUnix){
      const url = `${COINGECKO}/coins/bitcoin/market_chart/range?vs_currency=eur&from=${fromUnix}&to=${toUnix}`;
      const data = await fetchJson(url);

      const priceMap = new Map();
      for(const [ms, price] of (data.prices || [])){
        priceMap.set(dayKeyFromMs(ms), price);
      }
      return priceMap;
    }

    async function load(){
      destroyCharts();
      clearError();

      el("walletTitle").textContent = "Bitcoin";
      el("walletSub").textContent = "Wallet";

      document.title = `${WALLET_NAME} · Bitcoin`;

      el("walletName").textContent = WALLET_NAME;
      el("walletAddr").textContent = ADDRESS;

      el("explorerBtn").href = `https://mempool.space/address/${ADDRESS}`;
      
      // Set current date in todayPill
      el("todayPill").textContent = new Date().toLocaleDateString("de-DE", { day: "2-digit", month: "2-digit", year: "numeric" });

      setStatusLoading();

      try{
        const addr = await fetchJson(`${MEMPOOL}/address/${ADDRESS}`);
        const confirmedSats = (addr.chain_stats.funded_txo_sum - addr.chain_stats.spent_txo_sum) || 0;
        const pendingSats   = (addr.mempool_stats.funded_txo_sum - addr.mempool_stats.spent_txo_sum) || 0;
        const txCount = (addr.chain_stats.tx_count || 0) + (addr.mempool_stats.tx_count || 0);

        const confirmedBtc = satsToBtcNum(confirmedSats);
        const pendingBtc = satsToBtcNum(pendingSats);

        el("heroBtc").textContent = `${fmtBtcCompact(confirmedBtc)}`;
        el("heroSats").textContent = `${fmtSats(confirmedSats)}`;
        el("pendingPill").textContent = `Offen: ${fmtBtcCompact(pendingBtc)} BTC`;
        el("txCountPill").textContent = `Bewegungen: ${new Intl.NumberFormat("de-DE").format(txCount)}`;

        const recent = await fetchJson(`${MEMPOOL}/address/${ADDRESS}/txs`);
        el("txMeta").textContent = `${Math.min(recent.length, 25)} geladen`;
        renderTxList(recent);

        const confirmedAll = await fetchAllConfirmedTxs();

        const confirmedAsc = confirmedAll
          .filter(t => t.status?.confirmed && t.status.block_time)
          .sort((a,b) => a.status.block_time - b.status.block_time);

        const { startDay, todayDay, labels, balancesBtc, changeIdxSet } =
          buildDailyStepSeriesFromTxs(confirmedAsc);

        el("chartMeta").textContent = `${labels.length} Tage`;

        const priceMap = await fetchBtcEurPriceMap(startDay, todayDay + 86399);

        const eurValues = [];
        const prices = [];
        let lastPrice = null;

        for(let i=0;i<labels.length;i++){
          const dayUnix = startDay + i*86400;
          const key = dayKeyFromUnix(dayUnix);

          let p = priceMap.get(key);
          if(p == null) p = lastPrice;
          if(p == null) p = 0;

          lastPrice = p;

          prices.push(p);
          eurValues.push(balancesBtc[i] * p);
        }

        el("heroEur").textContent = lastPrice ? fmtEurNumberOnly(confirmedBtc * lastPrice) : "—";

        el("eurMeta").textContent = `${labels.length} Tage`;
        el("priceMeta").textContent = `${labels.length} Tage`;

        balanceChart = makeStepLine(
          el("balanceChart").getContext("2d"),
          labels, balancesBtc,
          "Bestand (BTC)",
          changeIdxSet, COLORS.btc
        );

        eurChart = makeStepLine(
          el("eurChart").getContext("2d"),
          labels, eurValues,
          "Wert (EUR)",
          changeIdxSet, COLORS.eur
        );

        priceChart = makeStepLine(
          el("priceChart").getContext("2d"),
          labels, prices,
          "BTC-Preis (EUR)",
          changeIdxSet, COLORS.price
        );

        setStatusOk();

      }catch(e){
        showError("Konnte Daten nicht laden: " + (e?.message || e));
      }
    }

    el("refreshBtn").addEventListener("click", load);
    load();
  </script>
</body>
</html>
